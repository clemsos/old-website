<!DOCTYPE html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Musical Landscape</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon"  type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAQAAVzABAEAjBQAaDwYAWjUGAGE6CQBrQQ0ATS8PAFhAJwBUQC8AbFI6AHVXPACBZk4A4NrWAPb19QAAAAAAAMmZmZmZmgAJIwAAAAAAcMIjPjA+PjAKpxIuMDMzMAm0Ii4zMzMACaIiLt3dMAAJtyIuIzPQAAm0Un5yM+IzKLRkfncy4iIotRF+dyLkIiq0QX53F+EiGrQUTkd34iIatEVu7u5iIVrBVVRBRFRVbAtGZGZla2uwAMu7u7u8vADAAwAAgAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAADAAwAA" />
	<meta name="Generator" content="Processing" />
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- - - - - - - - - - - - - - - - - - - - -
	+
	+    Wondering how this works?
	+
	+    Go to: http://processing.org/
	+    and: http://processingjs.org/
	+
	+ - - - - - - - - - - - - - - - - - - - - -->
	<style type="text/css">

	body {
		background-color: #333;
		color: #bbb; line-height: normal;
		font-family: Lucida Grande, Lucida Sans, Arial, Helvetica Neue, Verdana, Geneva, sans-serif;
		font-size: 11px; font-weight: normal; text-decoration: none;
		line-height: 1.5em;
	}
	a img {
		border: 0px solid transparent;
	}
	a, a:link, a:visited, a:active, a:hover {
		color: #cdcdcd; text-decoration: underline;
	}
	h1 {
		font-family: Arial, Helvetica Neue, Verdana, Geneva, sans-serif;
		width: 100%; letter-spacing: 0.1em;
		margin-bottom: 1em; font-size: 1.65em;
	}
	canvas {
		display: block;
		outline: 0px;
		margin-bottom: 1.5em;
	}
	#desc {
		width: 30%;
		float: left;
	}
	#landscape {
		width:70%;
		float: left;
	}

	#content {
		margin: 0 auto 0px auto; padding: 0 25px 15px 25px;
		width: 1000px; min-width: 300px; overflow: auto;
		border-left: 1px solid #444; border-top: 1px solid #444;
		border-right: 1px solid #333; border-bottom: 1px solid #333;
		/*background-color: #fff;*/
	}

	@media (max-width: 800px) {
		#content, #desc, #landscape {
			width: 100%;
			float : none;
			padding: 0;
		}
		#desc  {
			padding : 15px
		}
	}




	</style>
	<!--[if lt IE 9]>
	<script type="text/javascript">alert("Your browser does not support the canvas tag.");</script>
	<![endif]-->
	<script src="processing.js" type="text/javascript"></script>
	<script>

		/* OpenProcessing Tweak of *@*http://www.openprocessing.org/sketch/138877*@* */
		/* !do not delete the line above, required for linking your tweak if you upload again */
		// check if the default naming is enabled, if not use the chrome one.
		if (! window.AudioContext) {
		    if (! window.webkitAudioContext) {
		        alert('no audiocontext found');
		    }
		    window.AudioContext = window.webkitAudioContext;
		}



		var audioContext, analyserNode, javascriptNode, sourceNode;
		var frequencies = new Array();
		var tracks = new Array();
		var img = new Image();
		var ctx;

		var songs = [
			"Ketsa-Definition.mp3",
			"Fatbros.ogg",
			"Scott_Holmes-Rainbow_Street.mp3",
			"Broke_For_Free_-_01_-_Night_Owl.mp3",
			"BoxCat_Games_-_10_-_Epic_Song.mp3",
			"Shanxi_Yaolan_Qu_(Chine).mp3"
		];

		function changeSong(number) {
			var i = number ||  6;
			console.log(i)
			loadSound("./songs/" + songs[i-1]);
		}

		// load the specified sound
		function loadSound(url) {
			var request = new XMLHttpRequest();
			request.open('GET', url, true);
			request.responseType = 'arraybuffer';

			// When loaded decode the data
			request.onload = function() {

				// decode the data
				audioContext.decodeAudioData(request.response, function(buffer) {
					if (sourceNode.buffer) sourceNode.stop();
					// when the audio is decoded play the sound
					playSound(buffer);
				}, onError);
			}
			request.send();
		}


		function playSound(buffer) {
			sourceNode.buffer = buffer;
			sourceNode.start(0);
		}

		// log if an error occurs
		function onError(e) {
			console.log(e);
		}

		var processingInstance;
		function init(songIndex){
				if (!processingInstance) {
					processingInstance = Processing.getInstanceById('pjsComplexSketch');
				}
				sourceNode.disconnect();
				processingInstance.createBuffer();
				changeSong(songIndex);
		}
		</script>
		<script type="application/processing" data-processing-target="pjsComplexSketch">

			int bufferSize = 512;
			String musicUrl, artistName, musicName, info;
			int Y = -100;
			float sensib =1.5;
			float echelle;
			int step = 2;

			void setup(){
			    size(800, 800, P2D);
			    ctx = externals.context;
			    console.log(ctx);

			    background(0);

			    ctx.fillStyle = "rgba(0,0,0,.8)";
			    ctx.strokeStyle = "rgba(255,255,255,0.1)";

			    echelle = width/bufferSize;

			    setupAudioNodes();

			    changeSong();

			    cursor(HAND);
			}


			void draw(){
			    if(frameCount%3==0){
			        if(frameCount>6) ctx.drawImage(img, 0, -2);

			        ctx.beginPath();
			        ctx.moveTo(0,Y+frequencies[0]*sensib);
			        for(var i=step;i<bufferSize;i+=step){
			            ctx.lineTo(i*echelle,Y+frequencies[i]*sensib);
			        }
			        ctx.lineTo(width,Y+400);
			        ctx.lineTo(0,Y+400);
			        ctx.closePath();
			        ctx.fill();

			        for(var i=1; i<bufferSize-step; i+=step){
			            ctx.beginPath();
			            ctx.moveTo(i*echelle, Y+frequencies[i]*sensib);
			            ctx.lineTo(i+step, Y+frequencies[i+step]*sensib);
			            ctx.stroke();
			        }

			        img.src = document.getElementById("pjsComplexSketch").toDataURL("image/png");

			        if (Y<height-300) {
			            Y+=2;
			        }
			    }
			}

			void setupAudioNodes() {
			    audioContext = new AudioContext();

			    // setup a javascript node
			    javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
			    // connect to destination, else it isn't called
			    javascriptNode.connect(audioContext.destination);

			    javascriptNode.onaudioprocess = function() {
			        var array = new Uint8Array(analyserNode.frequencyBinCount);
			        analyserNode.getByteTimeDomainData(array);
			        frequencies = array;
			    }

			    analyserNode = audioContext.createAnalyser();
			    analyserNode.smoothingTimeConstant = 0.3;
			    analyserNode.fftSize = bufferSize * 2;

					createBuffer();
			}

		void createBuffer() {
			// create a buffer source node
			sourceNode = audioContext.createBufferSource();
			sourceNode.connect(analyserNode);
			analyserNode.connect(javascriptNode);
			sourceNode.connect(audioContext.destination);
		}

	</script>
</head>
<body>
	<div id="content">
		<div id="desc">
			<h1>Musical Lanscapes</h1>
			<p>
				By <a href="http://clementrenaud.com">Clément Renaud</a> and Lionel Radisson.
			</p>
			<p>Select a song :</p>
			<ul>
				<li><a onClick="init(6)" href="#4">Shanxi Yaolan Qu (Chine).mp3</a></li>
				<li><a onClick="init(1)" href="#0">Ketsa - Definition</a></li>
				<li><a onClick="init(2)" href="#1">Fatbros - Sk8</a></li>
				<li><a onClick="init(3)" href="#2">Scott Holmes -Rainbow Street</a></li>
				<li><a onClick="init(4)" href="#3">Broke For Free - Night Owl</a></li>
				<li><a onClick="init(5)" href="#4">BoxCat Games - Epic Song</a></li>
			</ul>
		</div>
		<div id="landscape">
			<canvas id="pjsComplexSketch" width="900" height="700">
			<p>Your browser does not support the canvas tag.</p>
			<!-- Note: you can put any alternative content here. -->
		</canvas>
		<noscript>
			<p>JavaScript is required to view the contents of this page.</p>
		</noscript>
	</div>

</div>
</body>
</html>
